import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';function t(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}function s(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}const n=Vue;function r(e,r={}){const{host:i='iframe',filter:a,prefix:d=s()}=r,o=new Map;let c=!1;const m=e=>{const t=Number($('#chat > .mes').first().attr('mesid'));return!_.inRange(e,t,SillyTavern.chat.length)&&(o.get(e)?.destroy(),!0)},l=()=>{o.keys().forEach(e=>m(e))},h=async(s,r)=>{if(c)return;if(m(s))return;const l=r??getChatMessages(s)[0].message??'';if(a&&!a(s,l))return void o.get(s)?.destroy();const h=$(`.mes[mesid='${s}']`),p=h.find('.mes_text').addClass('hidden!');h.find('.TH-streaming').addClass('hidden!');let g=h.find(`#${d}-${s}`);if(g.length>0){const e=o.get(s);if(e)return e.data.message=l,void(e.data.during_streaming=Boolean(r))}o.get(s)?.destroy(),g.remove();let f=h.find('.mes_streaming');0===f.length&&(f=$('<div class="mes_streaming">').css({'font-weight':'500','line-height':'calc(var(--mainFontSize) + .5rem)','max-width':'100%','overflow-wrap':'anywhere',padding:'calc(var(--mainFontSize) * 0.8) 0 0 0'}).insertAfter(p)),g=('iframe'===i?$('<iframe>').attr({script_id:getScriptId(),frameborder:0,srcdoc:'<!DOCTYPE html> <html> <head> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/lib/tailwindcss.min.js"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"><\/script> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/jquery-ui/themes/base/theme.min.css"/> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui-touch-punch"><\/script> <script src="https://testingcf.jsdelivr.net/npm/lodash"><\/script> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/src/iframe/adjust_iframe_height.js"><\/script> <style>*,::after,::before{box-sizing:border-box}body,html{margin:0!important;padding:0;overflow:hidden!important;max-width:100%!important}</style> </head> <html> </html></html>'}).addClass('w-full'):$('<div>').attr('script_id',getScriptId())).attr('id',`${d}-${s}`).appendTo(f);const v=(0,n.reactive)({prefix:d,host_id:`${d}-${s}`,message_id:s,message:l,during_streaming:Boolean(r)}),u=e().provide('streaming_message_context',v);'iframe'===i?g.on('load',function(){t(this.contentDocument.head),u.mount(this.contentDocument.body)}):u.mount(g[0]);const E=new MutationObserver(()=>{const e=$('#chat').find('#curEditTextarea');e.parent().is(p)?(p.removeClass('hidden!'),g.addClass('hidden!')):0===e.length&&(p.addClass('hidden!'),h.find('.TH-streaming').addClass('hidden!'),g.removeClass('hidden!'))});E.observe(p[0],{childList:!0}),o.set(s,{app:u,data:v,destroy:()=>{const e=h.find('.TH-streaming');e.length>0?e.removeClass('hidden!'):p.removeClass('hidden!'),u.unmount(),g.remove(),0===f.children().length&&f.remove(),E.disconnect(),o.delete(s)}})},p=async(e={})=>{c||(e.destroy_all?o.forEach(({destroy:e})=>e()):l(),await Promise.all($('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').map(async(t,s)=>{const n=Number($(s).attr('mesid')??'NaN');isNaN(n)||(await h(n),e.trigger_event&&eventEmit(tavern_events.CHARACTER_MESSAGE_RENDERED,n,'rerender'))})))},g=[],f=(e,t,s)=>{g.push(s?eventMakeFirst(e,errorCatched(t)).stop:eventOn(e,errorCatched(t)).stop)};return f('chatLoaded',()=>{p({destroy_all:!0})}),f(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>{l(),h(e)},!0),[tavern_events.MESSAGE_EDITED,tavern_events.MESSAGE_DELETED].forEach(e=>f(e,e=>{l(),o.get(e)?.destroy(),h(e)})),[tavern_events.MORE_MESSAGES_LOADED,tavern_events.MESSAGE_DELETED].forEach(e=>f(e,()=>setTimeout(errorCatched(p),1e3))),f(tavern_events.STREAM_TOKEN_RECEIVED,e=>{h(Number($('#chat').children('.mes.last_mes').attr('mesid')),e)}),'div'===i&&g.push(t().destroy),p({trigger_event:!0}),{unmount:()=>{const e=$('#chat').find('.TH-streaming');e.length>0?e.removeClass('hidden!'):$('chat').find('.mes_text').removeClass('hidden!'),o.forEach(({destroy:e})=>e()),g.forEach(e=>e()),c=!0}}}const i=(0,n.defineComponent)({__name:'App',setup(e){(0,n.readonly)((0,n.inject)('streaming_message_context'));return(e,t)=>((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,null,[(0,n.createCommentVNode)(' 优先使用 tailwindcss 制作样式 '),(0,n.createElementVNode)('div')],2112))}});$(()=>{const{unmount:t}=r(()=>(0,n.createApp)(i).use(e()));$(window).on('pagehide',()=>t())});
//# sourceMappingURL=index.js.map